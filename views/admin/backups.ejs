<%- include('../partials/header') %>

<h1><%= t('backups.title') %></h1>

<% if (rbacBypass) { %>
  <div class="alert alert-warning">
    <%= t('security.warnings.rbacDisabled') %>
  </div>
<% } %>

<!-- Backup Settings -->
<div class="card">
  <h2><%= t('backups.status') %></h2>

  <div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <div>
        <h3 style="margin-bottom: 0.5rem;"><%= t('backups.enabled') %></h3>
        <p style="color: #666; margin: 0;">
          <% if (backupSettings.enabled) { %>
            <span class="badge badge-success"><%= t('security.status.on') %></span>
          <% } else { %>
            <span class="badge badge-danger"><%= t('security.status.off') %></span>
          <% } %>
        </p>
      </div>
      <button class="btn <%= backupSettings.enabled ? 'btn-danger' : 'btn-success' %>"
              onclick="toggleBackups()">
        <%= backupSettings.enabled ? t('common.disable') : t('common.enable') %>
      </button>
    </div>

    <% if (backupSettings.enabled) { %>
      <div style="margin-top: 1.5rem;">
        <label for="backup-frequency" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
          <%= t('backups.frequency') %>:
        </label>
        <select id="backup-frequency" onchange="changeFrequency(this.value)"
                style="padding: 0.6rem; border-radius: 4px; border: 1px solid #ddd; width: 100%; max-width: 300px;">
          <option value="5" <%= backupSettings.frequency === 5 ? 'selected' : '' %>>
            <%= t('backups.frequencies.5') %>
          </option>
          <option value="15" <%= backupSettings.frequency === 15 ? 'selected' : '' %>>
            <%= t('backups.frequencies.15') %>
          </option>
          <option value="30" <%= backupSettings.frequency === 30 ? 'selected' : '' %>>
            <%= t('backups.frequencies.30') %>
          </option>
          <option value="60" <%= backupSettings.frequency === 60 ? 'selected' : '' %>>
            <%= t('backups.frequencies.60') %>
          </option>
          <option value="360" <%= backupSettings.frequency === 360 ? 'selected' : '' %>>
            <%= t('backups.frequencies.360') %>
          </option>
          <option value="720" <%= backupSettings.frequency === 720 ? 'selected' : '' %>>
            <%= t('backups.frequencies.720') %>
          </option>
          <option value="1440" <%= backupSettings.frequency === 1440 ? 'selected' : '' %>>
            <%= t('backups.frequencies.1440') %>
          </option>
        </select>
      </div>

      <div style="margin-top: 1rem;">
        <p><strong><%= t('backups.lastBackup') %>:</strong>
          <%= formatDate(backupSettings.lastBackup) %>
        </p>
      </div>
    <% } %>

    <div style="margin-top: 1.5rem;">
      <button class="btn btn-primary" onclick="createBackup()">
        <%= t('backups.backupNow') %>
      </button>
      <button class="btn btn-secondary" onclick="cleanupOldBackups()" style="margin-left: 1rem;">
        <%= t('backups.cleanupOld') %>
      </button>
    </div>
  </div>
</div>

<!-- Backup List -->
<div class="card" style="margin-top: 2rem;">
  <h2><%= t('backups.availableBackups') %> (<%= backups.length %>)</h2>

  <% if (backups.length === 0) { %>
    <p style="color: #666; font-style: italic;"><%= t('backups.noBackups') %></p>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th><%= t('backups.filename') %></th>
          <th><%= t('backups.created') %></th>
          <th><%= t('backups.size') %></th>
          <th><%= t('backups.actions') %></th>
        </tr>
      </thead>
      <tbody>
        <% backups.forEach(backup => { %>
          <tr>
            <td style="font-family: monospace; font-size: 0.9rem;"><%= backup.filename %></td>
            <td><%= formatDate(backup.created) %></td>
            <td><%= (backup.size / 1024).toFixed(2) %> KB</td>
            <td>
              <a href="/admin/backups/download/<%= backup.filename %>" class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                <%= t('backups.download') %>
              </a>
              <button class="btn btn-primary" onclick="restoreBackup('<%= backup.filename %>')"
                      style="padding: 0.3rem 0.8rem; font-size: 0.9rem; margin-left: 0.5rem;">
                <%= t('backups.restore') %>
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<script>
  window.__i18n = {
    confirmToggle: '<%= t("backups.confirmToggle").replace(/\x27/g, "\\x27") %>',
    backupCreated: '<%= t("backups.backupCreated").replace(/\x27/g, "\\x27") %>',
    confirmRestore: '<%= t("backups.confirmRestore").replace(/\x27/g, "\\x27") %>',
    backupRestored: '<%= t("backups.backupRestored").replace(/\x27/g, "\\x27") %>',
    confirmCleanup: '<%= t("backups.confirmCleanup").replace(/\x27/g, "\\x27") %>',
    cleanupComplete: '<%= t("backups.cleanupComplete").replace(/\x27/g, "\\x27") %>',
    frequencyUpdated: '<%= t("backups.frequencyUpdated").replace(/\x27/g, "\\x27") %>',
    genericError: '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>'
  };
</script>

<script>
  function toggleBackups() {
    if (!confirm(window.__i18n.confirmToggle)) return;

    fetch('/admin/backups/toggle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }

  function changeFrequency(frequency) {
    fetch('/admin/backups/set-frequency', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ frequency: parseInt(frequency) })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.frequencyUpdated);
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }

  function createBackup() {
    fetch('/admin/backups/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.backupCreated);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }

  function restoreBackup(filename) {
    if (!confirm(window.__i18n.confirmRestore)) {
      return;
    }

    fetch(`/admin/backups/restore/${filename}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.backupRestored);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }

  function cleanupOldBackups() {
    if (!confirm(window.__i18n.confirmCleanup)) return;

    fetch('/admin/backups/cleanup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.cleanupComplete);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }
</script>

<%- include('../partials/footer') %>
