<%- include('../partials/header') %>

<h1><%= t('sod.deletionRequests') %></h1>

<% if (rbacBypass) { %>
  <div class="alert alert-warning">
    <%= t('security.warnings.rbacDisabled') %>
  </div>
<% } %>

<!-- Pending Requests -->
<div class="card">
  <h2><%= t('sod.pendingRequests') %> (<%= pendingRequests.length %>)</h2>

  <% if (pendingRequests.length === 0) { %>
    <p style="color: #666; font-style: italic; margin-top: 1rem;">
      <%= t('sod.noPendingRequests') %>
    </p>
  <% } else { %>
    <table style="margin-top: 1rem;">
      <thead>
        <tr>
          <th><%= t('sod.requestId') %></th>
          <th><%= t('classes.code') %></th>
          <th><%= t('classes.name') %></th>
          <th><%= t('sod.requestedBy') %></th>
          <th><%= t('sod.requestedOn') %></th>
          <th><%= t('common.actions') %></th>
        </tr>
      </thead>
      <tbody>
        <% pendingRequests.forEach(request => { %>
          <tr>
            <td style="font-family: monospace;">#<%= request.id %></td>
            <td style="font-weight: 600;"><%= request.code || 'N/A' %></td>
            <td><%= request.name || 'Class not found' %></td>
            <td><%= request.username || 'Unknown' %></td>
            <td><%= formatDate(request.requested_at) %></td>
            <td>
              <button class="btn btn-success" onclick="approveRequest(<%= request.id %>)" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
                <%= t('sod.approve') %>
              </button>
              <button class="btn btn-danger" onclick="showRejectModal(<%= request.id %>, <%- JSON.stringify(request.code || '') %>)" style="padding: 0.4rem 0.8rem; font-size: 0.9rem; margin-left: 0.5rem;">
                <%= t('sod.reject') %>
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<!-- Completed Requests -->
<div class="card" style="margin-top: 2rem;">
  <h2><%= t('sod.completedRequests') %></h2>

  <% if (completedRequests.length === 0) { %>
    <p style="color: #666; font-style: italic; margin-top: 1rem;">
      <%= t('sod.noCompletedRequests') %>
    </p>
  <% } else { %>
    <table style="margin-top: 1rem;">
      <thead>
        <tr>
          <th><%= t('sod.requestId') %></th>
          <th><%= t('classes.code') %></th>
          <th><%= t('classes.name') %></th>
          <th><%= t('sod.requestedBy') %></th>
          <th><%= t('common.status') %></th>
          <th><%= t('sod.reviewedOn') %></th>
          <th><%= t('sod.details') %></th>
        </tr>
      </thead>
      <tbody>
        <% completedRequests.forEach(request => { %>
          <tr>
            <td style="font-family: monospace;">#<%= request.id %></td>
            <td style="font-weight: 600;"><%= request.code || 'N/A' %></td>
            <td><%= request.name || 'Deleted' %></td>
            <td><%= request.username || 'Unknown' %></td>
            <td>
              <% if (request.status === 'approved') { %>
                <span class="badge badge-success"><%= t('sod.approved') %></span>
              <% } else { %>
                <span class="badge badge-danger"><%= t('sod.rejected') %></span>
              <% } %>
            </td>
            <td><%= formatDate(request.reviewed_at) %></td>
            <td>
              <% if (request.status === 'rejected' && request.rejection_reason) { %>
                <button class="btn btn-secondary" onclick="showReason('<%= request.rejection_reason.replace(/'/g, "\\'") %>')" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;">
                  <%= t('sod.viewReason') %>
                </button>
              <% } else { %>
                <span style="color: #999;">-</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</div>

<!-- Reject Modal (Hidden) -->
<div id="reject-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
    <h3 style="margin-bottom: 1rem;"><%= t('sod.rejectRequest') %></h3>
    <p style="margin-bottom: 1rem; color: #666;">
      <%= t('sod.rejectPrompt') %>
    </p>
    <p style="margin-bottom: 1rem;"><strong><%= t('classes.code') %>:</strong> <span id="reject-class-code"></span></p>
    <textarea
      id="reject-reason"
      rows="4"
      style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; margin-bottom: 1rem; font-family: inherit;"
      placeholder="<%= t('sod.reasonPlaceholder') %>"
    ></textarea>
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button class="btn btn-secondary" onclick="closeRejectModal()"><%= t('common.cancel') %></button>
      <button class="btn btn-danger" onclick="submitRejection()"><%= t('sod.reject') %></button>
    </div>
  </div>
</div>

<script>
  window.__i18n = {
    confirmApprove: '<%= t("sod.confirmApprove").replace(/\x27/g, "\\x27") %>',
    approveSuccess: '<%= t("sod.approveSuccess").replace(/\x27/g, "\\x27") %>',
    provideReason: '<%= t("sod.provideReason").replace(/\x27/g, "\\x27") %>',
    rejectSuccess: '<%= t("sod.rejectSuccess").replace(/\x27/g, "\\x27") %>',
    rejectionReasonLabel: '<%= t("sod.rejectionReasonLabel").replace(/\x27/g, "\\x27") %>',
    genericError: '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>'
  };
</script>

<script>
  let currentRejectId = null;

  function approveRequest(requestId) {
    if (!confirm(window.__i18n.confirmApprove)) {
      return;
    }

    fetch(`/admin/deletion-requests/${requestId}/approve`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.approveSuccess);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }

  function showRejectModal(requestId, classCode) {
    currentRejectId = requestId;
    document.getElementById('reject-class-code').textContent = classCode;
    document.getElementById('reject-reason').value = '';
    document.getElementById('reject-modal').style.display = 'flex';
  }

  function closeRejectModal() {
    currentRejectId = null;
    document.getElementById('reject-modal').style.display = 'none';
  }

  function submitRejection() {
    const reason = document.getElementById('reject-reason').value.trim();
    if (!reason) {
      alert(window.__i18n.provideReason);
      return;
    }

    fetch(`/admin/deletion-requests/${currentRejectId}/reject`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.rejectSuccess);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }

  function showReason(reason) {
    alert(window.__i18n.rejectionReasonLabel + '\n\n' + reason);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeRejectModal();
  });
</script>

<%- include('../partials/footer') %>
