<%- include('../partials/header') %>

<div class="page-header">
  <h1 class="page-title"><%= t('security.panel.title') %></h1>
  <p class="page-subtitle"><%= t('security.panel.description') %></p>
</div>

<% if (typeof rbacBypass !== 'undefined' && rbacBypass) { %>
  <div class="alert alert-warning">
    <%= t('security.warnings.rbacDisabled') %>
  </div>
<% } %>

<style>
  .security-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
  }

  .security-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: box-shadow 0.2s;
  }

  .security-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  }

  .security-card-header {
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid #f0f0f0;
  }

  .security-card-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .security-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #002855;
    margin-bottom: 0.25rem;
  }

  .security-card-desc {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.4;
  }

  .security-card-body {
    padding: 1.25rem 1.5rem;
    background: #fafbfc;
  }

  .impact-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #999;
    margin-bottom: 0.5rem;
  }

  .impact-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
  }

  .impact-arrow {
    color: #ccc;
    font-weight: bold;
  }

  .impact-off {
    background: #f8d7da;
    color: #721c24;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-family: monospace;
  }

  .impact-on {
    background: #d4edda;
    color: #155724;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-family: monospace;
  }

  .toggle-switch {
    position: relative;
    width: 52px;
    height: 28px;
    flex-shrink: 0;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 28px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .toggle-switch input:checked + .toggle-slider {
    background-color: #27ae60;
  }

  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(24px);
  }

  .security-card-action {
    padding: 0 1.5rem 1.25rem;
    background: #fafbfc;
  }
</style>

<div class="security-grid">
  <!-- MFA Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x1F510;</div>
        <div class="security-card-title"><%= t('security.panel.mfa') %></div>
        <div class="security-card-desc"><%= t('security.panel.mfaDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.mfa_enabled ? 'checked' : '' %> onchange="toggleFeature('mfa_enabled')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.securityImpact') %></div>
      <div class="impact-row">
        <span class="impact-off"><%= t('security.panel.mfaOff') %></span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on"><%= t('security.panel.mfaOn') %></span>
      </div>
    </div>
    <div class="security-card-action">
      <a href="/admin/mfa-setup" class="btn btn-secondary" style="width: 100%; text-align: center;"><%= t('dashboard.admin.configureMfa') %></a>
    </div>
  </div>

  <!-- RBAC Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x1F465;</div>
        <div class="security-card-title"><%= t('security.panel.rbac') %></div>
        <div class="security-card-desc"><%= t('security.panel.rbacDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.rbac_enabled ? 'checked' : '' %> onchange="toggleFeature('rbac_enabled')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.securityImpact') %></div>
      <div class="impact-row">
        <span class="impact-off"><%= t('security.panel.rbacOff') %></span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on"><%= t('security.panel.rbacOn') %></span>
      </div>
    </div>
  </div>

  <!-- Password Encryption Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x1F511;</div>
        <div class="security-card-title"><%= t('security.panel.passwordEncryption') %></div>
        <div class="security-card-desc"><%= t('security.panel.passwordEncryptionDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.encryption_at_rest ? 'checked' : '' %> onchange="toggleFeature('encryption_at_rest')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.databaseStorage') %></div>
      <div class="impact-row">
        <span class="impact-off">admin123</span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on">$2b$10$xK3...</span>
      </div>
    </div>
  </div>

  <!-- Field Encryption Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x1F6E1;&#xFE0F;</div>
        <div class="security-card-title"><%= t('security.panel.fieldEncryption') %></div>
        <div class="security-card-desc"><%= t('security.panel.fieldEncryptionDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.field_encryption ? 'checked' : '' %> onchange="toggleFeature('field_encryption')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.sensitiveDataStorage') %></div>
      <div class="impact-row">
        <span class="impact-off">SSN: 123-45-6789</span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on">SSN: aGVsbG8...</span>
      </div>
    </div>
  </div>

  <!-- HTTPS Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x1F310;</div>
        <div class="security-card-title"><%= t('security.panel.https') %></div>
        <div class="security-card-desc"><%= t('security.panel.httpsDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.https_enabled ? 'checked' : '' %> onchange="toggleFeature('https_enabled')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.connectionSecurity') %></div>
      <div class="impact-row">
        <span class="impact-off">http://localhost</span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on">https://localhost</span>
      </div>
      <p style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;"><%= t('security.panel.requiresRestart') %></p>
    </div>
  </div>

  <!-- Audit Logging Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x1F4CB;</div>
        <div class="security-card-title"><%= t('security.panel.auditLogging') %></div>
        <div class="security-card-desc"><%= t('security.panel.auditLoggingDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.audit_logging ? 'checked' : '' %> onchange="toggleFeature('audit_logging')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.eventTracking') %></div>
      <div class="impact-row">
        <span class="impact-off"><%= t('security.panel.auditLoggingOff') %></span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on"><%= t('security.panel.auditLoggingOn') %></span>
      </div>
    </div>
    <div class="security-card-action">
      <a href="/admin/audit-logs" class="btn btn-secondary" style="width: 100%; text-align: center;"><%= t('dashboard.admin.viewAuditLogs') %></a>
    </div>
  </div>

  <!-- Rate Limiting Card -->
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x23F1;&#xFE0F;</div>
        <div class="security-card-title"><%= t('security.panel.rateLimiting') %></div>
        <div class="security-card-desc"><%= t('security.panel.rateLimitingDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.rate_limiting ? 'checked' : '' %> onchange="toggleFeature('rate_limiting')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.loginProtection') %></div>
      <div class="impact-row">
        <span class="impact-off"><%= t('security.panel.rateLimitingOff') %></span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on"><%= t('security.panel.rateLimitingOn') %></span>
      </div>
    </div>
  </div>

  <!-- Segregation of Duties Card -->
  <% if (typeof securitySettings.segregation_of_duties !== 'undefined') { %>
  <div class="security-card">
    <div class="security-card-header">
      <div>
        <div class="security-card-icon">&#x270B;</div>
        <div class="security-card-title"><%= t('security.panel.sod') %></div>
        <div class="security-card-desc"><%= t('security.panel.sodDesc') %></div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" <%= securitySettings.segregation_of_duties ? 'checked' : '' %> onchange="toggleFeature('segregation_of_duties')">
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="security-card-body">
      <div class="impact-label"><%= t('security.panel.deletionWorkflow') %></div>
      <div class="impact-row">
        <span class="impact-off"><%= t('security.panel.sodOff') %></span>
        <span class="impact-arrow">&rarr;</span>
        <span class="impact-on"><%= t('security.panel.sodOn') %></span>
      </div>
    </div>
  </div>
  <% } %>
</div>

<script>
  window.__i18n = {
    errorPrefix: '<%= t("common.error").replace(/\x27/g, "\\x27") %>',
    unknownError: '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>'
  };

  function toggleFeature(feature) {
    fetch('/admin/security/toggle/' + feature, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.requiresRestart) {
          alert(data.message);
        }
        location.reload();
      } else {
        alert(window.__i18n.errorPrefix + ': ' + (data.error || window.__i18n.unknownError));
        location.reload();
      }
    })
    .catch(err => {
      alert(window.__i18n.errorPrefix + ': ' + err.message);
      location.reload();
    });
  }
</script>

<%- include('../partials/footer') %>
