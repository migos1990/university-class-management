<%- include('../partials/header') %>

<h1><%= t('byok.title') %></h1>

<% if (rbacBypass) { %>
  <div class="alert alert-warning">
    <%= t('security.warnings.rbacDisabled') %>
  </div>
<% } %>

<!-- Current Key Status -->
<div class="card">
  <h2><%= t('byok.currentKeyStatus') %></h2>

  <div style="margin-bottom: 1.5rem;">
    <p><strong><%= t('byok.keyType') %>:</strong>
      <span class="badge <%= keyInfo.usingCustomKey ? 'badge-success' : 'badge-warning' %>">
        <%= keyInfo.usingCustomKey ? t('byok.custom') : t('byok.default') %>
      </span>
    </p>
    <p style="color: #666; font-size: 0.9rem;"><%= keyInfo.keyPath %></p>
  </div>

  <% if (fieldEncryptionEnabled) { %>
    <div class="alert alert-danger">
      <strong><%= t('byok.encryptionWarning') %>:</strong>
      <%= t('byok.encryptionWarningText') %>
    </div>
  <% } %>
</div>

<!-- Key Generation Instructions -->
<div class="card" style="margin-top: 2rem;">
  <h2><%= t('byok.generateKey') %></h2>

  <p style="margin-bottom: 1rem;">
    <%= t('byok.instructions') %>
  </p>

  <div style="margin-bottom: 1.5rem;">
    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Windows (PowerShell or Git Bash):</h3>
    <pre style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>openssl rand -base64 32</code></pre>

    <h3 style="margin-bottom: 0.5rem; margin-top: 1rem; font-size: 1rem;">Mac / Linux:</h3>
    <pre style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; overflow-x: auto;"><code>openssl rand -base64 32</code></pre>
  </div>

  <div class="alert alert-info">
    <strong><%= t('byok.note') %>:</strong>
    <%= t('byok.noteText') %>
  </div>
</div>

<!-- Upload Custom Key -->
<div class="card" style="margin-top: 2rem;">
  <h2><%= t('byok.uploadKey') %></h2>

  <form id="upload-key-form" style="margin-top: 1rem;">
    <div style="margin-bottom: 1rem;">
      <label for="custom-key" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
        <%= t('byok.pasteKey') %>
      </label>
      <textarea
        id="custom-key"
        name="customKey"
        rows="4"
        style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9rem;"
        placeholder="Example: 1vX9K7kJ2mN5pQ8rT3uV6wY0zA4bC7dE9fG2hI5jL8m="
        <%= fieldEncryptionEnabled ? 'disabled' : '' %>
      ></textarea>
    </div>

    <button
      type="submit"
      class="btn btn-primary"
      <%= fieldEncryptionEnabled ? 'disabled' : '' %>
    >
      <%= t('byok.uploadButton') %>
    </button>

    <% if (keyInfo.usingCustomKey) { %>
      <button
        type="button"
        class="btn btn-danger"
        onclick="deleteCustomKey()"
        style="margin-left: 1rem;"
        <%= fieldEncryptionEnabled ? 'disabled' : '' %>
      >
        <%= t('byok.deleteButton') %>
      </button>
    <% } %>
  </form>
</div>

<!-- Security Best Practices -->
<div class="card" style="margin-top: 2rem;">
  <h2><%= t('byok.bestPractices') %></h2>

  <ul style="margin-left: 1.5rem; color: #555;">
    <li style="margin-bottom: 0.5rem;">
      <%= t('byok.practice1') %>
    </li>
    <li style="margin-bottom: 0.5rem;">
      <%= t('byok.practice2') %>
    </li>
    <li style="margin-bottom: 0.5rem;">
      <%= t('byok.practice3') %>
    </li>
    <li style="margin-bottom: 0.5rem;">
      <%= t('byok.practice4') %>
    </li>
    <li style="margin-bottom: 0.5rem;">
      <%= t('byok.practice5') %>
    </li>
  </ul>
</div>

<script>
  window.__i18n = {
    enterKey: '<%= t("byok.enterKey").replace(/\x27/g, "\\x27") %>',
    keyTooShort: '<%= t("byok.keyTooShort").replace(/\x27/g, "\\x27") %>',
    confirmUpload: '<%= t("byok.confirmUpload").replace(/\x27/g, "\\x27") %>',
    uploadSuccess: '<%= t("byok.uploadSuccess").replace(/\x27/g, "\\x27") %>',
    confirmDelete: '<%= t("byok.confirmDelete").replace(/\x27/g, "\\x27") %>',
    deleteSuccess: '<%= t("byok.deleteSuccess").replace(/\x27/g, "\\x27") %>',
    genericError: '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>'
  };
</script>

<script>
  document.getElementById('upload-key-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const keyData = document.getElementById('custom-key').value.trim();

    if (!keyData) {
      alert(window.__i18n.enterKey);
      return;
    }

    if (keyData.length < 16) {
      alert(window.__i18n.keyTooShort);
      return;
    }

    if (!confirm(window.__i18n.confirmUpload)) {
      return;
    }

    fetch('/admin/byok/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ keyData })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.uploadSuccess);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  });

  function deleteCustomKey() {
    if (!confirm(window.__i18n.confirmDelete)) {
      return;
    }

    fetch('/admin/byok/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.deleteSuccess);
        location.reload();
      } else {
        alert(window.__i18n.genericError + ': ' + (data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
  }
</script>

<%- include('../partials/footer') %>
