<%- include('../partials/header') %>

<h1><%= t('mfa.setupTitle') %></h1>

<div class="card">
  <% if (alreadyEnabled) { %>
    <div class="alert alert-info">
      <%= t('mfa.alreadySetup') %>
    </div>

    <p style="margin-top: 1rem;">
      <%= t('mfa.alreadySetupDesc') %>
    </p>

    <div style="margin-top: 2rem;">
      <button onclick="disableMFA()" class="btn btn-danger"><%= t('common.disable') %> MFA</button>
      <a href="/admin/security" class="btn btn-secondary"><%= t('header.securityPanel') %></a>
    </div>

    <script>
      window.__i18n = {
        confirmDisable: '<%= t("mfa.confirmDisable").replace(/\x27/g, "\\x27") %>',
        disabledSuccess: '<%= t("mfa.disabledSuccess").replace(/\x27/g, "\\x27") %>',
        genericError: '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>'
      };

      function disableMFA() {
        if (confirm(window.__i18n.confirmDisable)) {
          fetch('/admin/mfa-disable', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert(window.__i18n.disabledSuccess);
              location.reload();
            } else {
              alert(window.__i18n.genericError);
            }
          })
          .catch(err => alert(window.__i18n.genericError + ': ' + err.message));
        }
      }
    </script>
  <% } else { %>
    <h2><%= t('mfa.step1Title') %></h2>
    <p style="color: #666; margin-bottom: 1rem;">
      <%= t('mfa.step1Desc') %>
    </p>
    <ul style="margin-left: 2rem; margin-bottom: 2rem; color: #666;">
      <li><a href="https://apps.apple.com/app/google-authenticator/id388497605" target="_blank">iOS App Store</a></li>
      <li><a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" target="_blank">Google Play Store</a></li>
    </ul>

    <h2><%= t('mfa.step2Title') %></h2>
    <p style="color: #666; margin-bottom: 1rem;">
      <%= t('mfa.step2Desc') %>
    </p>

    <div style="text-align: center; margin: 2rem 0; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
      <img src="<%= qrCodeUrl %>" alt="QR Code" style="max-width: 250px; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    </div>

    <p style="color: #666; margin-bottom: 0.5rem;">
      <strong><%= t('mfa.manualEntry') %>:</strong> <%= t('mfa.manualEntryDesc') %>
    </p>
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-family: monospace; word-break: break-all; margin-bottom: 2rem;">
      <%= secret %>
    </div>

    <h2><%= t('mfa.step3Title') %></h2>
    <p style="color: #666; margin-bottom: 1rem;">
      <%= t('mfa.step3Desc') %>
    </p>

    <div id="error-message" style="display: none;" class="alert alert-danger"></div>
    <div id="success-message" style="display: none;" class="alert alert-info"></div>

    <div style="display: flex; gap: 1rem; align-items: center;">
      <input type="text" id="mfa-code" placeholder="<%= t('mfa.enterCode') %>" maxlength="6" pattern="[0-9]{6}"
             style="width: 200px; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem; font-family: monospace;">
      <button onclick="verifyCode()" class="btn btn-success"><%= t('mfa.verifyAndEnable') %></button>
    </div>

    <script>
      window.__i18n = window.__i18n || {};
      window.__i18n.enterValidCode = '<%= t("mfa.enterValidCode").replace(/\x27/g, "\\x27") %>';
      window.__i18n.enabledSuccess = '<%= t("mfa.enabledSuccess").replace(/\x27/g, "\\x27") %>';
      window.__i18n.verificationFailed = '<%= t("mfa.verificationFailed").replace(/\x27/g, "\\x27") %>';
      window.__i18n.genericError = '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>';

      function verifyCode() {
        const code = document.getElementById('mfa-code').value;

        if (code.length !== 6) {
          showError(window.__i18n.enterValidCode);
          return;
        }

        fetch('/admin/mfa-setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showSuccess(window.__i18n.enabledSuccess);
            setTimeout(() => location.href = '/admin/security', 2000);
          } else {
            showError(data.error || window.__i18n.verificationFailed);
          }
        })
        .catch(err => showError(window.__i18n.genericError + ': ' + err.message));
      }

      function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('success-message').style.display = 'none';
      }

      function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('error-message').style.display = 'none';
      }

      // Allow Enter key to submit
      document.getElementById('mfa-code').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          verifyCode();
        }
      });
    </script>
  <% } %>
</div>

<%- include('../partials/footer') %>
