<%- include('../partials/header') %>

<script>
  window.__i18n = {
    confirmPushToVM: '<%= t("labs.sca.confirmPushToVM").replace(/\x27/g, "\\x27") %>',
    importing: '<%= t("labs.importing").replace(/\x27/g, "\\x27") %>',
    importFailed: '<%= t("labs.importFailed").replace(/\x27/g, "\\x27") %>',
    networkError: '<%= t("labs.networkError").replace(/\x27/g, "\\x27") %>'
  };
</script>

<div class="page-header">
  <h1 class="page-title"><%= t('labs.sca.instructorTitle') %></h1>
  <p class="page-subtitle"><%= findings.length %> <%= t('labs.findings') %> &nbsp;|&nbsp; <%= students.length %> <%= t('labs.students') %> &nbsp;|&nbsp; <%= allReviews.length %> <%= t('labs.reviewsSubmitted') %></p>
</div>

<style>
  .sev-Critical  { background:#ffe0e0; color:#c0392b; }
  .sev-High      { background:#fff0e0; color:#c0732a; }
  .sev-Medium    { background:#fffbe0; color:#9a7d0a; }
  .sev-Low       { background:#e8f8e8; color:#1e8449; }
  .sev-Info      { background:#e8f0ff; color:#1a5276; }
  .badge-sm { display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:600; }
  .cls-confirmed      { background:#d4edda; color:#155724; }
  .cls-false_positive { background:#f8d7da; color:#721c24; }
  .cls-needs          { background:#fff3cd; color:#856404; }
  .cls-none           { background:#e9ecef; color:#6c757d; }
  .progress-bar-wrap { background:#e9ecef; border-radius:4px; height:6px; margin-top:4px; }
  .progress-bar-fill { height:6px; border-radius:4px; background:#002855; }
  .matrix-cell { text-align:center; padding:4px 2px; font-size:0.7rem; }
  .action-btn { padding:4px 10px; border:none; border-radius:4px; cursor:pointer; font-size:0.8rem; }
  .btn-import   { background:#002855; color:#fff; }
  .btn-imported { background:#e9ecef; color:#6c757d; cursor:default; }
  details summary { cursor:pointer; font-weight:600; padding:0.5rem 0; }
</style>

<div class="card" style="margin-bottom:1.5rem;">
  <h2 style="margin-bottom:1rem;"><%= t('labs.sca.findingsOverview') %></h2>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th><%= t('labs.title') %></th>
        <th><%= t('labs.sca.file') %></th>
        <th><%= t('labs.severity') %></th>
        <th><%= t('labs.sca.cwe') %></th>
        <th><%= t('labs.sca.reviews') %></th>
        <th><%= t('labs.sca.vm') %></th>
      </tr>
    </thead>
    <tbody>
      <% findings.forEach(f => {
        const reviews = Object.values(matrix[f.id] || {});
        const confirmed = reviews.filter(r=>r.classification==='confirmed').length;
        const fp       = reviews.filter(r=>r.classification==='false_positive').length;
        const submitted = reviews.filter(r=>r.status==='submitted').length;
        const pct = students.length ? Math.round(submitted/students.length*100) : 0;
        const inVM = importedIds.has(f.id);
      %>
      <tr>
        <td style="width:36px;"><%= f.id %></td>
        <td>
          <a href="/sca/findings/<%= f.id %>" style="font-weight:600; color:#002855; text-decoration:none;">
            <%= f.title %>
          </a><br>
          <small style="color:#666;"><%= f.file_path %>:<%= f.line_number %></small>
        </td>
        <td><code style="font-size:0.8rem;"><%= f.file_path %></code></td>
        <td><span class="badge-sm sev-<%= f.severity %>"><%= f.severity %></span></td>
        <td><a href="https://cwe.mitre.org/data/definitions/<%= f.cwe.replace('CWE-','') %>.html" target="_blank" style="font-size:0.85rem;"><%= f.cwe %></a></td>
        <td style="min-width:120px;">
          <div style="font-size:0.8rem; color:#666;"><%= submitted %>/<%= students.length %> <%= t('labs.submitted') %></div>
          <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:<%= pct %>%;"></div></div>
          <div style="margin-top:4px; display:flex; gap:4px; flex-wrap:wrap;">
            <span class="badge-sm cls-confirmed"><%= confirmed %> <%= t('labs.sca.confirmed') %></span>
            <span class="badge-sm cls-false_positive"><%= fp %> <%= t('labs.sca.fp') %></span>
          </div>
        </td>
        <td>
          <% if (inVM) { %>
            <button class="action-btn btn-imported" disabled><%= t('labs.sca.inVm') %></button>
          <% } else { %>
            <button class="action-btn btn-import" onclick="importToVM(<%= f.id %>, this)"><%= t('labs.sca.pushToVm') %></button>
          <% } %>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<div class="card">
  <h2 style="margin-bottom:1rem;"><%= t('labs.sca.studentProgressMatrix') %></h2>
  <div style="overflow-x:auto;">
    <table style="min-width:600px;">
      <thead>
        <tr>
          <th style="min-width:100px;"><%= t('labs.finding') %></th>
          <% students.forEach(s => { %>
            <th style="min-width:90px; font-size:0.8rem;">
              <a href="/sca/student/<%= s.id %>" style="color:#002855;">
                <%= s.username.replace('_student','') %>
              </a>
            </th>
          <% }) %>
        </tr>
      </thead>
      <tbody>
        <% findings.forEach(f => { %>
        <tr>
          <td style="font-size:0.8rem; font-weight:600;"><%= f.title.substring(0,30) %><%= f.title.length>30?'…':'' %></td>
          <% students.forEach(s => {
            const r = (matrix[f.id] || {})[s.id];
          %>
          <td class="matrix-cell">
            <% if (!r) { %>
              <span class="badge-sm cls-none">—</span>
            <% } else { %>
              <span class="badge-sm cls-<%= r.classification === 'needs_investigation' ? 'needs' : r.classification %>">
                <%= r.classification === 'confirmed' ? '✓' : r.classification === 'false_positive' ? 'FP' : '?' %>
              </span>
              <% if (r.status === 'submitted') { %><div style="font-size:0.65rem;color:#1e8449;"><%= t('labs.submitted') %></div><% } %>
            <% } %>
          </td>
          <% }) %>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script>
async function importToVM(findingId, btn) {
  if (!confirm(window.__i18n.confirmPushToVM)) return;
  btn.disabled = true;
  btn.textContent = window.__i18n.importing;
  try {
    const res = await fetch(`/sca/import-to-vm/${findingId}`, { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      btn.textContent = '<%= t("labs.sca.inVm") %>';
      btn.className = 'action-btn btn-imported';
    } else {
      btn.disabled = false;
      btn.textContent = '<%= t("labs.sca.pushToVm") %>';
      alert(data.error || window.__i18n.importFailed);
    }
  } catch (e) {
    btn.disabled = false;
    btn.textContent = '<%= t("labs.sca.pushToVm") %>';
    alert(window.__i18n.networkError);
  }
}
</script>

<%- include('../partials/footer') %>
