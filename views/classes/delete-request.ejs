<%- include('../partials/header') %>

<h1><%= t('sod.requestDeletion') %></h1>

<div class="card">
  <h2><%= t('sod.classDetails') %></h2>

  <table style="margin-top: 1rem; width: 100%;">
    <tr>
      <th style="width: 200px; text-align: right; padding-right: 1rem;"><%= t('classes.code') %>:</th>
      <td><strong><%= classData.code %></strong></td>
    </tr>
    <tr>
      <th style="text-align: right; padding-right: 1rem;"><%= t('classes.name') %>:</th>
      <td><%= classData.name %></td>
    </tr>
    <tr>
      <th style="text-align: right; padding-right: 1rem;"><%= t('classes.description') %>:</th>
      <td><%= classData.description || 'N/A' %></td>
    </tr>
    <tr>
      <th style="text-align: right; padding-right: 1rem;"><%= t('classes.semester') %>:</th>
      <td><%= classData.semester %></td>
    </tr>
  </table>
</div>

<% if (existingRequest) { %>
  <div class="card" style="margin-top: 2rem;">
    <h2><%= t('sod.pendingRequest') %></h2>

    <div class="alert alert-info" style="margin-top: 1rem;">
      <p><strong><%= t('sod.alreadySubmitted') %></strong></p>
      <p style="margin-top: 0.5rem;">
        <strong><%= t('sod.requestedOn') %>:</strong> <%= new Date(existingRequest.requested_at).toLocaleString() %>
      </p>
      <p style="margin-top: 0.5rem; color: #666;">
        <%= t('sod.waitingApproval') %>
      </p>
    </div>

    <div style="margin-top: 1.5rem;">
      <a href="/classes/<%= classData.id %>" class="btn btn-secondary"><%= t('classes.backToClass') %></a>
    </div>
  </div>
<% } else { %>
  <div class="card" style="margin-top: 2rem;">
    <h2><%= t('sod.sodWorkflow') %></h2>

    <div class="alert alert-warning" style="margin-top: 1rem;">
      <p><strong><%= t('sod.sodEnabled') %></strong></p>
      <p style="margin-top: 0.5rem; color: #666;">
        <%= t('sod.workflowExplanation') %>
      </p>
    </div>

    <div style="margin-top: 1.5rem;">
      <h3 style="font-size: 1.1rem; margin-bottom: 1rem;"><%= t('sod.howItWorks') %>:</h3>
      <ol style="margin-left: 1.5rem; color: #555; line-height: 1.8;">
        <li><%= t('sod.step1') %></li>
        <li><%= t('sod.step2') %></li>
        <li><%= t('sod.step3') %></li>
        <li><%= t('sod.step4') %></li>
      </ol>
    </div>

    <div class="alert alert-danger" style="margin-top: 1.5rem;">
      <strong><%= t('common.warning') %>:</strong>
      <%= t('sod.deletionWarning') %>
    </div>

    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
      <button class="btn btn-danger" onclick="submitRequest()">
        <%= t('sod.submitRequest') %>
      </button>
      <a href="/classes/<%= classData.id %>" class="btn btn-secondary"><%= t('common.cancel') %></a>
    </div>
  </div>
<% } %>

<script>
  window.__i18n = {
    confirmSubmit: '<%= t("sod.confirmSubmit").replace(/\x27/g, "\\x27") %>',
    requestSubmitted: '<%= t("sod.requestSubmitted").replace(/\x27/g, "\\x27") %>',
    genericError: '<%= t("errors.genericError").replace(/\x27/g, "\\x27") %>'
  };
  function submitRequest() {
    if (!confirm(window.__i18n.confirmSubmit)) {
      return;
    }

    fetch('/classes/<%= classData.id %>/delete-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(window.__i18n.requestSubmitted);
        location.reload();
      } else {
        alert(window.__i18n.genericError.replace('{error}', data.error || ''));
      }
    })
    .catch(err => alert(window.__i18n.genericError.replace('{error}', err.message)));
  }
</script>

<%- include('../partials/footer') %>
