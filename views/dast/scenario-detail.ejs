<%- include('../partials/header') %>

<script>
  window.__i18n = {
    confirmPushToVM: '<%= t("labs.dast.confirmPushToVM").replace(/\x27/g, "\\x27") %>',
    importedToVM: '<%= t("labs.importedToVM").replace(/\x27/g, "\\x27") %>',
    importFailed: '<%= t("labs.importFailed").replace(/\x27/g, "\\x27") %>',
    networkError: '<%= t("labs.networkError").replace(/\x27/g, "\\x27") %>',
    checkingPrecondition: '<%= t("labs.dast.checkingPrecondition").replace(/\x27/g, "\\x27") %>'
  };
</script>

<div class="page-header">
  <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
    <a href="/dast" style="color:#666; text-decoration:none; font-size:0.9rem;">&larr; <%= t('labs.dast.backToLab') %></a>
    <h1 class="page-title" style="margin:0;"><%= scenario.title %></h1>
  </div>
</div>

<style>
  .sev-Critical  { background:#ffe0e0; color:#c0392b; }
  .sev-High      { background:#fff0e0; color:#c0732a; }
  .sev-Medium    { background:#fffbe0; color:#9a7d0a; }
  .sev-Low       { background:#e8f8e8; color:#1e8449; }
  .badge-sm { display:inline-block; padding:2px 10px; border-radius:4px; font-size:0.8rem; font-weight:600; }
  .precondition-box { border-radius:6px; padding:0.6rem 0.9rem; font-size:0.9rem; }
  .pre-met   { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
  .pre-unmet { background:#fff3cd; color:#856404; border:1px solid #ffeeba; }
</style>

<div style="display:grid; grid-template-columns:2fr 1fr; gap:1.5rem; align-items:start;">

  <!-- Left -->
  <div>
    <div class="card" style="margin-bottom:1rem;">
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;">
        <span class="badge-sm sev-<%= scenario.severity %>"><%= scenario.severity %></span>
        <span class="badge-sm" style="background:#e8f0ff;color:#1a5276;"><%= scenario.vulnerability_type %></span>
        <span class="badge-sm" style="background:#f0f0f0;color:#333;"><%= scenario.owasp_category %></span>
        <% if (scenario.cvss_base_score) { %><span class="badge-sm" style="background:#f0f0f0;color:#333;">CVSS <%= scenario.cvss_base_score %></span><% } %>
      </div>

      <p style="margin-bottom:1rem; line-height:1.7;"><%= scenario.description %></p>

      <!-- Live precondition indicator -->
      <div id="precondition-box" class="precondition-box pre-unmet" style="margin-bottom:1rem;">
        <%= t('labs.dast.checkingPrecondition') %>
      </div>

      <h3 style="margin-bottom:0.75rem;"><%= t('labs.dast.stepByStep') %></h3>
      <ol style="padding-left:1.5rem; line-height:2.2; margin-bottom:1rem;">
        <% steps.forEach((step, i) => { %>
          <li style="margin-bottom:0.25rem;"><%= step %></li>
        <% }) %>
      </ol>

      <% if (scenario.affected_file) { %>
      <div style="background:#f8f9fa; border-radius:6px; padding:0.75rem; font-size:0.9rem;">
        <strong><%= t('labs.dast.affectedFile') %>:</strong> <code><%= scenario.affected_file %></code>
        <% if (scenario.affected_lines) { %> <%= t('labs.dast.lines') %> <%= scenario.affected_lines %><% } %>
      </div>
      <% } %>
    </div>

    <% if (user.role !== 'student' && allFindings.length > 0) { %>
    <div class="card">
      <h3 style="margin-bottom:1rem;"><%= t('labs.dast.studentSubmissions') %> (<%= allFindings.length %>)</h3>
      <table>
        <thead>
          <tr><th><%= t('labs.student') %></th><th><%= t('labs.dast.triggered') %></th><th><%= t('labs.severity') %></th><th><%= t('labs.status') %></th><th><%= t('labs.grade') %></th></tr>
        </thead>
        <tbody>
          <% allFindings.forEach(f => { %>
          <tr>
            <td>#<%= f.student_id %></td>
            <td>
              <span class="badge-sm" style="background:<%= f.triggered ? '#d4edda' : '#f8d7da' %>; color:<%= f.triggered ? '#155724' : '#721c24' %>;">
                <%= f.triggered ? t('labs.yes') : t('labs.no') %>
              </span>
            </td>
            <td><%= f.severity_rating || '&mdash;' %></td>
            <td style="font-size:0.85rem;"><%= f.submitted_at ? t('labs.submitted') : t('labs.draft') %></td>
            <td><%= f.grade || '&mdash;' %></td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>
  </div>

  <!-- Right -->
  <div>
    <% if (user.role === 'student') { %>
    <div class="card">
      <h3 style="margin-bottom:1rem;"><%= t('labs.dast.yourFinding') %></h3>
      <% if (myFinding && myFinding.submitted_at) { %>
        <div style="background:#d4edda; border-radius:6px; padding:0.75rem; margin-bottom:1rem; color:#155724;">
          &#10003; <%= t('labs.submittedOn') %> <%= new Date(myFinding.submitted_at).toLocaleString() %>
        </div>
      <% } %>
      <form method="POST" action="/dast/scenarios/<%= scenario.id %>/findings">
        <div style="margin-bottom:0.75rem;">
          <label style="font-weight:600; display:block; margin-bottom:0.4rem;"><%= t('labs.dast.triggered') %>?</label>
          <label style="margin-right:1rem;"><input type="radio" name="triggered" value="1" <%= myFinding && myFinding.triggered ? 'checked':'' %>> <%= t('labs.yes') %></label>
          <label><input type="radio" name="triggered" value="0" <%= myFinding && !myFinding.triggered ? 'checked':'' %>> <%= t('labs.no') %></label>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="font-weight:600; display:block; margin-bottom:0.4rem;"><%= t('labs.dast.evidence') %></label>
          <textarea name="trigger_evidence" rows="3" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;"><%= myFinding ? (myFinding.trigger_evidence||'') : '' %></textarea>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="font-weight:600; display:block; margin-bottom:0.4rem;"><%= t('labs.dast.impactAssessment') %></label>
          <textarea name="impact_assessment" rows="3" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;"><%= myFinding ? (myFinding.impact_assessment||'') : '' %></textarea>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="font-weight:600; display:block; margin-bottom:0.4rem;"><%= t('labs.dast.reproductionSteps') %></label>
          <textarea name="reproduction_steps" rows="3" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;"><%= myFinding ? (myFinding.reproduction_steps||'') : '' %></textarea>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="font-weight:600; display:block; margin-bottom:0.4rem;"><%= t('labs.dast.recommendation') %></label>
          <textarea name="recommendation" rows="3" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;"><%= myFinding ? (myFinding.recommendation||'') : '' %></textarea>
        </div>
        <div style="margin-bottom:1rem;">
          <label style="font-weight:600; display:block; margin-bottom:0.4rem;"><%= t('labs.dast.severityRating') %></label>
          <select name="severity_rating" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;">
            <option value=""><%= t('labs.select') %></option>
            <% ['Critical','High','Medium','Low','Info'].forEach(sev => { %>
              <option value="<%= sev %>" <%= myFinding && myFinding.severity_rating === sev ? 'selected':'' %>><%= sev %></option>
            <% }) %>
          </select>
        </div>
        <div style="display:flex; gap:0.5rem;">
          <button type="submit" name="action" value="save" style="background:#6c757d; color:#fff; border:none; border-radius:4px; padding:8px 14px; cursor:pointer;"><%= t('labs.saveDraft') %></button>
          <button type="submit" name="action" value="submit" style="background:#002855; color:#fff; border:none; border-radius:4px; padding:8px 14px; cursor:pointer;"><%= t('common.submit') %></button>
        </div>
      </form>
    </div>
    <% } %>

    <% if (user.role !== 'student') { %>
    <div class="card">
      <h3 style="margin-bottom:1rem;"><%= t('labs.vm.managerTitle') %></h3>
      <% if (vmEntry) { %>
        <div style="background:#d4edda; border-radius:6px; padding:0.75rem; color:#155724;">
          &#10003; <%= t('labs.sca.importedToVmAs') %> <a href="/vm/vulns/<%= vmEntry.id %>" style="color:#155724; font-weight:600;">#<%= vmEntry.id %></a>
        </div>
      <% } else { %>
        <button onclick="importScenario()" style="background:#002855; color:#fff; border:none; border-radius:4px; padding:8px 16px; cursor:pointer;"><%= t('labs.sca.pushToVm') %></button>
      <% } %>
    </div>
    <% } %>

    <div class="card">
      <h3 style="margin-bottom:0.5rem;"><%= t('labs.dast.expectedFinding') %></h3>
      <p style="font-size:0.9rem; color:#444; line-height:1.6;"><%= scenario.expected_finding %></p>
    </div>
  </div>
</div>

<script>
(async function checkPrecondition() {
  try {
    const res = await fetch('/dast/scenarios/<%= scenario.id %>/precondition');
    const data = await res.json();
    const el = document.getElementById('precondition-box');
    el.className = 'precondition-box ' + (data.met ? 'pre-met' : 'pre-unmet');
    el.textContent = data.message;
  } catch(e) {}
})();

<% if (user.role !== 'student') { %>
async function importScenario() {
  if (!confirm(window.__i18n.confirmPushToVM)) return;
  try {
    const res = await fetch('/dast/import-to-vm/<%= scenario.id %>', {method:'POST'});
    const data = await res.json();
    if (data.success) { alert(window.__i18n.importedToVM); location.reload(); }
    else alert(data.error || window.__i18n.importFailed);
  } catch(e) { alert(window.__i18n.networkError); }
}
<% } %>
</script>

<%- include('../partials/footer') %>
