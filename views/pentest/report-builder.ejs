<%- include('../partials/header') %>

<div class="page-header">
  <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
    <div>
      <div><a href="/pentest/my" style="color:#666; text-decoration:none; font-size:0.9rem;">&larr; <%= t('labs.pentest.backToLab') %></a></div>
      <h1 class="page-title"><%= t('labs.pentest.reportTitle') %></h1>
      <p class="page-subtitle"><%= t('labs.status') %>: <strong><%= eng.status.replace('_',' ') %></strong></p>
    </div>
    <button onclick="window.print()" style="background:#002855; color:#fff; border:none; border-radius:6px; padding:10px 20px; cursor:pointer; font-size:0.9rem;"><%= t('labs.pentest.printExport') %></button>
  </div>
</div>

<style>
  .sev-Critical  { background:#ffe0e0; color:#c0392b; }
  .sev-High      { background:#fff0e0; color:#c0732a; }
  .sev-Medium    { background:#fffbe0; color:#9a7d0a; }
  .sev-Low       { background:#e8f8e8; color:#1e8449; }
  .badge-sm { display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:600; }
  .report-section { margin-bottom:2rem; }
  .finding-block { border:1px solid #dee2e6; border-radius:6px; padding:1rem; margin-bottom:1rem; }
  .finding-block h4 { margin:0 0 0.5rem; }
  dl { display:grid; grid-template-columns:140px 1fr; gap:0.25rem 0.75rem; font-size:0.9rem; }
  dt { font-weight:600; color:#555; }
  dd { color:#333; }
  @media print {
    .sidebar, .security-status, .page-header button, a { display:none !important; }
    .main-content { margin-left:0 !important; }
    .card { box-shadow:none !important; border:1px solid #dee2e6 !important; }
  }
</style>

<div class="card report-section">
  <h2 style="margin-bottom:0.5rem;"><%= t('labs.pentest.executiveSummary') %></h2>
  <dl>
    <dt><%= t('labs.pentest.date') %></dt><dd><%= new Date().toLocaleDateString('en-CA') %></dd>
    <dt><%= t('labs.status') %></dt><dd><%= eng.status.replace('_',' ') %></dd>
    <dt><%= t('labs.pentest.totalFindings') %></dt><dd><%= findings.length %></dd>
    <dt><%= t('labs.pentest.criticalHigh') %></dt><dd><%= findings.filter(f=>f.severity==='Critical'||f.severity==='High').length %></dd>
    <dt><%= t('labs.grade') %></dt><dd><%= eng.instructor_grade || t('labs.pentest.notGraded') %></dd>
  </dl>
  <% if (eng.instructor_feedback) { %>
    <div style="margin-top:1rem; padding:0.75rem; background:#f8f9fa; border-radius:6px;">
      <strong><%= t('labs.instructorFeedback') %>:</strong>
      <p style="margin:0.5rem 0 0; font-size:0.9rem; line-height:1.6;"><%= eng.instructor_feedback %></p>
    </div>
  <% } %>
</div>

<div class="card report-section">
  <h2 style="margin-bottom:1rem;"><%= t('labs.pentest.findingsSummary') %></h2>
  <table>
    <thead>
      <tr><th>#</th><th><%= t('labs.title') %></th><th><%= t('labs.pentest.phase') %></th><th><%= t('labs.severity') %></th><th><%= t('labs.pentest.affectedUrl') %></th></tr>
    </thead>
    <tbody>
      <% findings.forEach((f, i) => { %>
      <tr>
        <td><%= i+1 %></td>
        <td><strong><%= f.title %></strong></td>
        <td style="font-size:0.85rem;"><%= PHASE_LABELS[f.phase] || f.phase %></td>
        <td><span class="badge-sm sev-<%= f.severity %>"><%= f.severity %></span></td>
        <td style="font-size:0.85rem;"><code><%= f.affected_url || '&mdash;' %></code></td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<% PHASES.forEach(phase => { %>
<div class="card report-section">
  <h2 style="margin-bottom:0.5rem;"><%= PHASE_LABELS[phase] %></h2>
  <% const note = notesMap[phase]; %>
  <% if (note && note.notes) { %>
    <div style="margin-bottom:0.75rem;">
      <h4 style="color:#555; font-size:0.9rem; margin-bottom:0.25rem;"><%= t('labs.pentest.observations') %></h4>
      <p style="font-size:0.9rem; line-height:1.7; white-space:pre-line;"><%= note.notes %></p>
    </div>
  <% } %>
  <% if (note && note.tools_used) { %>
    <div style="margin-bottom:0.75rem;">
      <h4 style="color:#555; font-size:0.9rem; margin-bottom:0.25rem;"><%= t('labs.pentest.toolsUsed') %></h4>
      <p style="font-size:0.9rem; line-height:1.7;"><%= note.tools_used %></p>
    </div>
  <% } %>
  <% const phaseFindings = findingsByPhase[phase] || []; %>
  <% phaseFindings.forEach((f, i) => { %>
  <div class="finding-block">
    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
      <span class="badge-sm sev-<%= f.severity %>"><%= f.severity %></span>
      <h4><%= f.title %></h4>
    </div>
    <dl>
      <% if (f.affected_url) { %><dt><%= t('labs.vm.affected') %></dt><dd><code style="font-size:0.85rem;"><%= f.affected_url %></code></dd><% } %>
      <% if (f.cvss_score) { %><dt><%= t('labs.pentest.cvssScore') %></dt><dd><%= f.cvss_score %></dd><% } %>
      <% if (f.description) { %><dt><%= t('labs.description') %></dt><dd style="white-space:pre-line;"><%= f.description %></dd><% } %>
      <% if (f.evidence) { %><dt><%= t('labs.pentest.evidence') %></dt><dd style="white-space:pre-line;"><%= f.evidence %></dd><% } %>
      <% if (f.recommendation) { %><dt><%= t('labs.pentest.recommendation') %></dt><dd style="white-space:pre-line;"><%= f.recommendation %></dd><% } %>
    </dl>
  </div>
  <% }) %>
  <% if (!phaseFindings.length) { %>
    <p style="color:#999; font-size:0.9rem;"><%= t('labs.pentest.noFindingsInPhase') %></p>
  <% } %>
</div>
<% }) %>

<%- include('../partials/footer') %>
