<%- include('../partials/header') %>

<script>
  window.__i18n = {
    saving: '<%= t("labs.saving").replace(/\x27/g, "\\x27") %>',
    saved: '<%= t("labs.saved").replace(/\x27/g, "\\x27") %>',
    importing: '<%= t("labs.importing").replace(/\x27/g, "\\x27") %>',
    networkError: '<%= t("labs.networkError").replace(/\x27/g, "\\x27") %>',
    done: '<%= t("labs.done").replace(/\x27/g, "\\x27") %>',
    imported: '<%= t("labs.pentest.imported").replace(/\x27/g, "\\x27") %>',
    skipped: '<%= t("labs.pentest.skipped").replace(/\x27/g, "\\x27") %>'
  };
</script>

<div class="page-header">
  <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
    <a href="/pentest" style="color:#666; text-decoration:none; font-size:0.9rem;">&larr; <%= t('labs.pentest.instructorTitle') %></a>
    <h1 class="page-title" style="margin:0;"><%= student ? student.username : t('labs.student') + ' #' + eng.student_id %> â€” <%= t('labs.pentest.pentestEngagement') %></h1>
  </div>
</div>

<style>
  .sev-Critical  { background:#ffe0e0; color:#c0392b; }
  .sev-High      { background:#fff0e0; color:#c0732a; }
  .sev-Medium    { background:#fffbe0; color:#9a7d0a; }
  .sev-Low       { background:#e8f8e8; color:#1e8449; }
  .badge-sm { display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:600; }
</style>

<div style="display:grid; grid-template-columns:2fr 1fr; gap:1.5rem; align-items:start;">
  <div>
    <div class="card" style="margin-bottom:1rem;">
      <dl style="display:grid; grid-template-columns:140px 1fr; gap:0.25rem 0.75rem; font-size:0.9rem;">
        <dt style="font-weight:600;"><%= t('labs.status') %></dt><dd><strong><%= eng.status.replace('_',' ') %></strong></dd>
        <dt style="font-weight:600;"><%= t('labs.pentest.currentPhase') %></dt><dd><%= PHASE_LABELS[eng.phase_current] || eng.phase_current %></dd>
        <dt style="font-weight:600;"><%= t('labs.pentest.started') %></dt><dd><%= new Date(eng.started_at).toLocaleString() %></dd>
        <dt style="font-weight:600;"><%= t('labs.submitted') %></dt><dd><%= eng.submitted_at ? new Date(eng.submitted_at).toLocaleString() : '&mdash;' %></dd>
        <dt style="font-weight:600;"><%= t('labs.grade') %></dt><dd><%= eng.instructor_grade || '&mdash;' %></dd>
      </dl>
      <% if (eng.instructor_feedback) { %>
        <div style="margin-top:1rem; padding:0.75rem; background:#f8f9fa; border-radius:6px; font-size:0.9rem;">
          <strong><%= t('labs.instructorFeedback') %>:</strong>
          <p style="margin:0.5rem 0 0;"><%= eng.instructor_feedback %></p>
        </div>
      <% } %>
    </div>

    <% PHASES.forEach(phase => {
      const phaseFindings = findings.filter(f => f.phase === phase);
      const note = notesMap[phase];
    %>
    <div class="card" style="margin-bottom:1rem;">
      <h3 style="margin-bottom:0.75rem;"><%= PHASE_LABELS[phase] %> (<%= phaseFindings.length %> <%= t('labs.findings').toLowerCase() %>)</h3>
      <% if (note && note.notes) { %>
        <p style="font-size:0.9rem; color:#444; line-height:1.6; margin-bottom:0.75rem; white-space:pre-line;"><%= note.notes %></p>
      <% } %>
      <% if (note && note.tools_used) { %>
        <p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem;"><strong><%= t('labs.pentest.tools') %>:</strong> <%= note.tools_used %></p>
      <% } %>
      <% phaseFindings.forEach(f => { %>
      <div style="border:1px solid #dee2e6; border-radius:6px; padding:0.75rem; margin-bottom:0.5rem;">
        <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.25rem;">
          <span class="badge-sm sev-<%= f.severity %>"><%= f.severity %></span>
          <strong><%= f.title %></strong>
        </div>
        <% if (f.affected_url) { %><p style="font-size:0.85rem; color:#666; margin:0.25rem 0;"><code><%= f.affected_url %></code></p><% } %>
        <% if (f.description) { %><p style="font-size:0.9rem; color:#444; margin:0.25rem 0; line-height:1.6;"><%= f.description %></p><% } %>
        <% if (f.evidence) { %><p style="font-size:0.85rem; color:#555;"><strong><%= t('labs.pentest.evidence') %>:</strong> <%= f.evidence %></p><% } %>
        <% if (f.recommendation) { %><p style="font-size:0.85rem; color:#555;"><strong><%= t('labs.pentest.rec') %>:</strong> <%= f.recommendation %></p><% } %>
      </div>
      <% }) %>
      <% if (!phaseFindings.length) { %><p style="color:#999; font-size:0.9rem;"><%= t('labs.pentest.noFindings') %></p><% } %>
    </div>
    <% }) %>
  </div>

  <div>
    <div class="card" style="margin-bottom:1rem;">
      <h3 style="margin-bottom:1rem;"><%= t('labs.pentest.gradeEngagement') %></h3>
      <div style="margin-bottom:0.75rem;">
        <label style="display:block; font-weight:600; margin-bottom:0.4rem;"><%= t('labs.grade') %></label>
        <input type="text" id="gradeVal" value="<%= eng.instructor_grade || '' %>" placeholder="<%= t('labs.gradePlaceholder') %>" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;">
      </div>
      <div style="margin-bottom:0.75rem;">
        <label style="display:block; font-weight:600; margin-bottom:0.4rem;"><%= t('labs.pentest.feedback') %></label>
        <textarea id="feedbackVal" rows="5" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;"><%= eng.instructor_feedback || '' %></textarea>
      </div>
      <button onclick="saveGrade()" style="background:#002855; color:#fff; border:none; border-radius:4px; padding:8px 16px; cursor:pointer;"><%= t('labs.pentest.saveGrade') %></button>
      <div id="gradeMsg" style="margin-top:0.5rem; font-size:0.9rem;"></div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:0.75rem;"><%= t('labs.pentest.importToVmTitle') %></h3>
      <p style="font-size:0.9rem; color:#666; margin-bottom:0.75rem;"><%= t('labs.pentest.pushAllFindings') %> (<%= findings.length %>)</p>
      <button onclick="importToVM()" style="background:#5b2c8c; color:#fff; border:none; border-radius:4px; padding:8px 16px; cursor:pointer;"><%= t('labs.pentest.importAllToVm') %></button>
      <div id="importMsg" style="margin-top:0.5rem; font-size:0.9rem;"></div>
    </div>
  </div>
</div>

<script>
async function saveGrade() {
  const grade = document.getElementById('gradeVal').value;
  const feedback = document.getElementById('feedbackVal').value;
  const msg = document.getElementById('gradeMsg');
  try {
    const res = await fetch('/pentest/engagements/<%= eng.id %>/grade', {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
      body:`instructor_grade=${encodeURIComponent(grade)}&instructor_feedback=${encodeURIComponent(feedback)}`
    });
    const data = await res.json();
    msg.style.color = data.success ? '#155724' : '#721c24';
    msg.textContent = data.success ? window.__i18n.saved : (data.error || window.__i18n.networkError);
  } catch(e) { msg.style.color='#721c24'; msg.textContent=window.__i18n.networkError; }
}

async function importToVM() {
  const msg = document.getElementById('importMsg');
  msg.textContent = window.__i18n.importing;
  try {
    const res = await fetch('/pentest/import-to-vm/<%= eng.id %>', {method:'POST',headers:{'Accept':'application/json'}});
    const data = await res.json();
    msg.style.color = '#155724';
    msg.textContent = `${window.__i18n.done}: ${data.imported} ${window.__i18n.imported}, ${data.skipped} ${window.__i18n.skipped}.`;
  } catch(e) { msg.style.color='#721c24'; msg.textContent=window.__i18n.networkError; }
}
</script>

<%- include('../partials/footer') %>
