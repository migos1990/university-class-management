<%- include('../partials/header') %>

<div class="page-header">
  <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
    <div>
      <h1 class="page-title">Pentest Lab</h1>
      <p class="page-subtitle">Status: <strong><%= eng.status.replace('_',' ') %></strong> &nbsp;·&nbsp; Current phase: <strong><%= PHASE_LABELS[eng.phase_current] %></strong></p>
    </div>
    <div style="display:flex; gap:0.5rem; align-items:center;">
      <a href="/pentest/my/report" style="background:#5b2c8c; color:#fff; text-decoration:none; border-radius:6px; padding:8px 16px; font-size:0.9rem;">View Report</a>
      <% if (eng.status !== 'submitted' && eng.status !== 'graded') { %>
        <button onclick="submitEngagement()" style="background:#1e8449; color:#fff; border:none; border-radius:6px; padding:8px 16px; cursor:pointer; font-size:0.9rem;">Submit Engagement</button>
      <% } %>
    </div>
  </div>
</div>

<style>
  .sev-Critical  { background:#ffe0e0; color:#c0392b; }
  .sev-High      { background:#fff0e0; color:#c0732a; }
  .sev-Medium    { background:#fffbe0; color:#9a7d0a; }
  .sev-Low       { background:#e8f8e8; color:#1e8449; }
  .badge-sm { display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:600; }
  .phase-card { border:1px solid #dee2e6; border-radius:8px; margin-bottom:1rem; overflow:hidden; }
  .phase-header { padding:1rem 1.25rem; display:flex; align-items:center; justify-content:space-between; cursor:pointer; user-select:none; }
  .phase-header.active  { background:#002855; color:#fff; }
  .phase-header.done    { background:#e8f8e8; }
  .phase-header.locked  { background:#f8f9fa; color:#999; }
  .phase-body { padding:1.25rem; background:#fff; display:none; }
  .finding-row { display:flex; align-items:center; gap:0.5rem; padding:0.5rem 0; border-bottom:1px solid #f0f0f0; }
</style>

<!-- Phase stepper -->
<div style="display:flex; align-items:center; gap:0; margin-bottom:1.5rem; overflow-x:auto;">
  <% PHASES.forEach((p, i) => {
    const currentIdx = PHASES.indexOf(eng.phase_current);
    const state = i < currentIdx ? 'done' : i === currentIdx ? 'active' : 'todo';
    const colors = {done:'#1e8449', active:'#002855', todo:'#adb5bd'};
  %>
  <div style="display:flex; align-items:center; flex-shrink:0;">
    <div style="width:32px; height:32px; border-radius:50%; background:<%= colors[state] %>; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.9rem;">
      <%= state === 'done' ? '✓' : (i + 1) %>
    </div>
    <div style="font-size:0.8rem; margin-left:6px; color:<%= colors[state] %>; font-weight:<%= state==='active'?'700':'400' %>; white-space:nowrap;">
      <%= PHASE_LABELS[p] %>
    </div>
  </div>
  <% if (i < PHASES.length - 1) { %><div style="width:40px; height:2px; background:#dee2e6; margin:0 4px;"></div><% } %>
  <% }) %>
</div>

<% const currentIdx = PHASES.indexOf(eng.phase_current); %>
<% PHASES.forEach((phase, i) => {
  const isActive = phase === eng.phase_current;
  const isDone   = i < currentIdx;
  const isLocked = i > currentIdx;
  const phaseFindings = findingsByPhase[phase] || [];
  const phaseNote = notesMap[phase];
  const headerClass = isActive ? 'active' : isDone ? 'done' : 'locked';
%>
<div class="phase-card" id="phase-card-<%= phase %>">
  <div class="phase-header <%= headerClass %>" onclick="togglePhase('<%= phase %>')">
    <span style="font-weight:600;">
      <%= isDone ? '✓ ' : '' %><%= PHASE_LABELS[phase] %>
      <% if (phaseFindings.length) { %><span style="font-size:0.8rem; font-weight:400; margin-left:0.5rem;">(<%= phaseFindings.length %> findings)</span><% } %>
    </span>
    <% if (isLocked) { %><span style="font-size:0.85rem;">Locked — complete previous phase first</span><% } %>
    <% if (isActive && nextPhase) { %>
      <button onclick="advancePhase(event)" style="background:#fff; color:#002855; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; font-size:0.85rem; font-weight:600;">
        Advance to <%= PHASE_LABELS[nextPhase] %> →
      </button>
    <% } %>
  </div>

  <div class="phase-body" id="body-<%= phase %>" style="<%= isActive ? 'display:block;' : '' %>">
    <!-- Phase notes -->
    <div style="margin-bottom:1rem;">
      <label style="font-weight:600; display:block; margin-bottom:0.4rem;">Phase Notes & Tools Used</label>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem;">
        <div>
          <label style="font-size:0.85rem; color:#666; display:block; margin-bottom:0.3rem;">Narrative / Observations</label>
          <textarea id="notes-<%= phase %>" rows="4" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.85rem;"
            <% if (isLocked || eng.status === 'submitted' || eng.status === 'graded') { %>disabled<% } %>><%= phaseNote ? phaseNote.notes : '' %></textarea>
        </div>
        <div>
          <label style="font-size:0.85rem; color:#666; display:block; margin-bottom:0.3rem;">Tools Used</label>
          <textarea id="tools-<%= phase %>" rows="4" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.85rem;"
            <% if (isLocked || eng.status === 'submitted' || eng.status === 'graded') { %>disabled<% } %>><%= phaseNote ? phaseNote.tools_used : '' %></textarea>
        </div>
      </div>
      <% if (!isLocked && eng.status !== 'submitted' && eng.status !== 'graded') { %>
        <button onclick="saveNotes('<%= phase %>')" style="margin-top:0.5rem; background:#6c757d; color:#fff; border:none; border-radius:4px; padding:6px 14px; cursor:pointer; font-size:0.85rem;">Save Notes</button>
        <span id="notes-msg-<%= phase %>" style="font-size:0.85rem; margin-left:0.5rem;"></span>
      <% } %>
    </div>

    <!-- Findings -->
    <h4 style="margin-bottom:0.75rem;">Findings in this phase (<%= phaseFindings.length %>)</h4>
    <div id="findings-list-<%= phase %>">
      <% phaseFindings.forEach(f => { %>
      <div class="finding-row" id="finding-row-<%= f.id %>">
        <span class="badge-sm sev-<%= f.severity %>"><%= f.severity %></span>
        <span style="flex:1; font-size:0.9rem;"><strong><%= f.title %></strong><% if(f.affected_url) { %> — <code style="font-size:0.8rem;"><%= f.affected_url %></code><% } %></span>
        <% if (!isLocked && eng.status !== 'submitted' && eng.status !== 'graded') { %>
          <button onclick="deleteFinding(<%= f.id %>, '<%= phase %>')" style="background:none; border:none; cursor:pointer; color:#c0392b; font-size:1rem;">✕</button>
        <% } %>
      </div>
      <% }) %>
      <% if (!phaseFindings.length) { %>
        <div id="no-findings-<%= phase %>" style="color:#999; font-size:0.9rem; padding:0.5rem 0;">No findings yet.</div>
      <% } else { %>
        <div id="no-findings-<%= phase %>" style="display:none;"></div>
      <% } %>
    </div>

    <% if (!isLocked && eng.status !== 'submitted' && eng.status !== 'graded') { %>
    <div style="margin-top:0.75rem; border-top:1px solid #f0f0f0; padding-top:0.75rem;">
      <button onclick="toggleAddFinding('<%= phase %>')" style="background:#002855; color:#fff; border:none; border-radius:4px; padding:6px 14px; cursor:pointer; font-size:0.85rem;">+ Add Finding</button>
      <div id="add-finding-<%= phase %>" style="display:none; margin-top:0.75rem; padding:1rem; background:#f8f9fa; border-radius:6px;">
        <div style="display:grid; grid-template-columns:2fr 1fr; gap:0.75rem; margin-bottom:0.75rem;">
          <div>
            <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.3rem;">Title *</label>
            <input type="text" id="f-title-<%= phase %>" style="width:100%; padding:7px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
          </div>
          <div>
            <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.3rem;">Severity</label>
            <select id="f-severity-<%= phase %>" style="width:100%; padding:7px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
              <% ['Critical','High','Medium','Low','Info'].forEach(s => { %><option value="<%= s %>" <%= s==='Medium'?'selected':'' %>><%= s %></option><% }) %>
            </select>
          </div>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.3rem;">Affected URL / Component</label>
          <input type="text" id="f-url-<%= phase %>" style="width:100%; padding:7px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.3rem;">Description</label>
          <textarea id="f-desc-<%= phase %>" rows="2" style="width:100%; padding:7px; border:1px solid #ced4da; border-radius:4px; font-size:0.85rem;"></textarea>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.3rem;">Evidence</label>
          <textarea id="f-evidence-<%= phase %>" rows="2" style="width:100%; padding:7px; border:1px solid #ced4da; border-radius:4px; font-size:0.85rem;"></textarea>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.3rem;">Recommendation</label>
          <textarea id="f-rec-<%= phase %>" rows="2" style="width:100%; padding:7px; border:1px solid #ced4da; border-radius:4px; font-size:0.85rem;"></textarea>
        </div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
          <button onclick="addFinding('<%= phase %>')" style="background:#002855;color:#fff;border:none;border-radius:4px;padding:7px 14px;cursor:pointer;font-size:0.85rem;">Add</button>
          <button onclick="toggleAddFinding('<%= phase %>')" style="background:none;border:1px solid #dee2e6;border-radius:4px;padding:7px 12px;cursor:pointer;font-size:0.85rem;">Cancel</button>
          <span id="add-msg-<%= phase %>" style="font-size:0.85rem;"></span>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>
<% }) %>

<div id="globalMsg" style="position:fixed; bottom:1rem; right:1rem; padding:0.75rem 1.25rem; border-radius:6px; font-size:0.9rem; display:none; z-index:999;"></div>

<script>
function togglePhase(phase) {
  const body = document.getElementById('body-' + phase);
  body.style.display = body.style.display === 'none' ? 'block' : 'none';
}

function toggleAddFinding(phase) {
  const el = document.getElementById('add-finding-' + phase);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function saveNotes(phase) {
  const notes = document.getElementById('notes-' + phase).value;
  const tools = document.getElementById('tools-' + phase).value;
  const msg = document.getElementById('notes-msg-' + phase);
  msg.textContent = 'Saving…';
  try {
    const res = await fetch(`/pentest/my/phases/${phase}/notes`, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
      body:`notes=${encodeURIComponent(notes)}&tools_used=${encodeURIComponent(tools)}`
    });
    const data = await res.json();
    msg.style.color = data.success ? '#155724' : '#721c24';
    msg.textContent = data.success ? '✓ Saved' : (data.error || 'Error');
  } catch(e) { msg.style.color='#721c24'; msg.textContent='Network error'; }
}

async function addFinding(phase) {
  const title    = document.getElementById('f-title-'    + phase).value.trim();
  const severity = document.getElementById('f-severity-' + phase).value;
  const url      = document.getElementById('f-url-'      + phase).value;
  const desc     = document.getElementById('f-desc-'     + phase).value;
  const evidence = document.getElementById('f-evidence-' + phase).value;
  const rec      = document.getElementById('f-rec-'      + phase).value;
  const msg      = document.getElementById('add-msg-'    + phase);

  if (!title) { msg.style.color='#721c24'; msg.textContent='Title required.'; return; }
  msg.textContent = 'Adding…';

  try {
    const body = `title=${encodeURIComponent(title)}&severity=${encodeURIComponent(severity)}&affected_url=${encodeURIComponent(url)}&description=${encodeURIComponent(desc)}&evidence=${encodeURIComponent(evidence)}&recommendation=${encodeURIComponent(rec)}`;
    const res = await fetch(`/pentest/my/phases/${phase}/findings`, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json'},
      body
    });
    const data = await res.json();
    if (data.success) {
      msg.style.color = '#155724'; msg.textContent = '✓ Added';
      setTimeout(() => location.reload(), 500);
    } else { msg.style.color='#721c24'; msg.textContent = data.error || 'Error'; }
  } catch(e) { msg.style.color='#721c24'; msg.textContent='Network error'; }
}

async function deleteFinding(id, phase) {
  if (!confirm('Delete this finding?')) return;
  try {
    const res = await fetch(`/pentest/my/findings/${id}/delete`, {method:'POST',headers:{'Accept':'application/json'}});
    const data = await res.json();
    if (data.success) {
      const row = document.getElementById('finding-row-' + id);
      if (row) row.remove();
    } else alert(data.error);
  } catch(e) { alert('Network error'); }
}

async function advancePhase(event) {
  event.stopPropagation();
  try {
    const res = await fetch('/pentest/my/phase/advance', {method:'POST',headers:{'Accept':'application/json'}});
    const data = await res.json();
    if (data.success) {
      showMsg(`Advanced to ${data.nextLabel}! Reloading…`, '#155724');
      setTimeout(() => location.reload(), 800);
    } else { showMsg(data.error, '#721c24'); }
  } catch(e) { showMsg('Network error', '#721c24'); }
}

async function submitEngagement() {
  if (!confirm('Submit your pentest engagement? You will not be able to add more findings after submission.')) return;
  try {
    const res = await fetch('/pentest/my/submit', {method:'POST',headers:{'Accept':'application/json'}});
    const data = await res.json();
    if (data.success) { showMsg('Engagement submitted!', '#155724'); setTimeout(()=>location.reload(),800); }
    else showMsg(data.error, '#721c24');
  } catch(e) { showMsg('Network error','#721c24'); }
}

function showMsg(text, color) {
  const el = document.getElementById('globalMsg');
  el.style.background = color; el.style.color='#fff';
  el.textContent = text; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}
</script>

<%- include('../partials/footer') %>
