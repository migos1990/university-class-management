<%- include('../partials/header') %>

<div class="page-header">
  <h1 class="page-title">Pentest Lab — Instructor Dashboard</h1>
  <p class="page-subtitle"><%= engagements.length %> engagements</p>
</div>

<style>
  .badge-sm { display:inline-block; padding:2px 8px; border-radius:4px; font-size:0.75rem; font-weight:600; }
  .st-in_progress { background:#fef9e7; color:#9a7d0a; }
  .st-submitted   { background:#e8f0ff; color:#1a5276; }
  .st-graded      { background:#e8f8e8; color:#1e8449; }
  .st-not_started { background:#f0f0f0; color:#555; }
  .phase-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:2px; }
  .phase-done { background:#1e8449; }
  .phase-curr { background:#002855; }
  .phase-todo { background:#dee2e6; }
</style>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Student</th>
        <th>Status</th>
        <th>Phase Progress</th>
        <th>Findings</th>
        <th>Grade</th>
        <th>Submitted</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if (!engagements.length) { %>
      <tr><td colspan="7" style="text-align:center; color:#999; padding:2rem;">No student engagements yet. Students will see their lab when they visit /pentest.</td></tr>
      <% } %>
      <% engagements.forEach(eng => {
        const student = studentMap[eng.student_id];
        const currentIdx = PHASES.indexOf(eng.phase_current);
      %>
      <tr>
        <td><strong><%= student ? student.username : '#' + eng.student_id %></strong></td>
        <td><span class="badge-sm st-<%= eng.status %>"><%= eng.status.replace('_',' ') %></span></td>
        <td>
          <div style="display:flex; align-items:center; gap:3px;">
            <% PHASES.forEach((p, i) => {
              let cls = i < currentIdx ? 'phase-done' : i === currentIdx ? 'phase-curr' : 'phase-todo';
            %>
              <span class="phase-dot <%= cls %>" title="<%= PHASE_LABELS[p] %>"></span>
            <% }) %>
            <span style="font-size:0.8rem; color:#666; margin-left:4px;"><%= PHASE_LABELS[eng.phase_current] %></span>
          </div>
        </td>
        <td style="text-align:center; font-size:0.9rem;">
          <a href="/pentest/engagements/<%= eng.id %>" style="color:#002855;">View</a>
        </td>
        <td>
          <% if (eng.instructor_grade) { %>
            <span style="font-weight:600; color:#1e8449;"><%= eng.instructor_grade %></span>
          <% } else { %>
            <button onclick="openGrade(<%= eng.id %>, '<%= (eng.instructor_feedback||'').replace(/'/g,'') %>', '<%= eng.instructor_grade||'' %>')"
              style="background:#002855;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:0.8rem;">
              Grade
            </button>
          <% } %>
        </td>
        <td style="font-size:0.85rem;">
          <%= eng.submitted_at ? new Date(eng.submitted_at).toLocaleDateString() : '—' %>
        </td>
        <td>
          <a href="/pentest/engagements/<%= eng.id %>" style="font-size:0.85rem; color:#002855; margin-right:0.5rem;">Detail →</a>
          <% if (eng.status === 'submitted' || eng.status === 'graded') { %>
            <button onclick="importToVM(<%= eng.id %>, this)" style="font-size:0.75rem; background:#5b2c8c; color:#fff; border:none; border-radius:4px; padding:3px 8px; cursor:pointer;">
              Import to VM
            </button>
          <% } %>
        </td>
      </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Grade modal -->
<div id="gradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:8px; padding:1.5rem; width:480px; max-width:95vw;">
    <h3 style="margin-bottom:1rem;">Grade Engagement</h3>
    <input type="hidden" id="gradeEngId">
    <div style="margin-bottom:0.75rem;">
      <label style="display:block; font-weight:600; margin-bottom:0.4rem;">Grade</label>
      <input type="text" id="gradeVal" placeholder="A, B+, 85, etc." style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;">
    </div>
    <div style="margin-bottom:1rem;">
      <label style="display:block; font-weight:600; margin-bottom:0.4rem;">Feedback</label>
      <textarea id="feedbackVal" rows="4" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px;"></textarea>
    </div>
    <div style="display:flex; gap:0.5rem; justify-content:flex-end;">
      <button onclick="document.getElementById('gradeModal').style.display='none'" style="border:1px solid #dee2e6;background:none;border-radius:4px;padding:8px 14px;cursor:pointer;">Cancel</button>
      <button onclick="saveGrade()" style="background:#002855;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;">Save Grade</button>
    </div>
  </div>
</div>

<script>
function openGrade(id, feedback, grade) {
  document.getElementById('gradeEngId').value = id;
  document.getElementById('gradeVal').value = grade;
  document.getElementById('feedbackVal').value = feedback;
  document.getElementById('gradeModal').style.display = 'flex';
}
async function saveGrade() {
  const id = document.getElementById('gradeEngId').value;
  const grade = document.getElementById('gradeVal').value;
  const feedback = document.getElementById('feedbackVal').value;
  try {
    const res = await fetch(`/pentest/engagements/${id}/grade`, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:`instructor_grade=${encodeURIComponent(grade)}&instructor_feedback=${encodeURIComponent(feedback)}`
    });
    const data = await res.json();
    if (data.success) { document.getElementById('gradeModal').style.display='none'; location.reload(); }
    else alert(data.error);
  } catch(e) { alert('Network error'); }
}
async function importToVM(engId, btn) {
  if (!confirm('Import all findings from this engagement to the VM?')) return;
  btn.disabled = true; btn.textContent = 'Importing…';
  try {
    const res = await fetch(`/pentest/import-to-vm/${engId}`, {method:'POST'});
    const data = await res.json();
    btn.textContent = `Done (${data.imported} imported, ${data.skipped} skipped)`;
  } catch(e) { btn.disabled=false; btn.textContent='Import to VM'; alert('Error'); }
}
</script>

<%- include('../partials/footer') %>
