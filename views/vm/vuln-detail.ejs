<%- include('../partials/header') %>

<div class="page-header">
  <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
    <a href="/vm" style="color:#666; text-decoration:none; font-size:0.9rem;">← VM Registry</a>
    <h1 class="page-title" style="margin:0;">#<%= vuln.id %>: <%= vuln.title %></h1>
  </div>
</div>

<style>
  .sev-Critical  { background:#ffe0e0; color:#c0392b; }
  .sev-High      { background:#fff0e0; color:#c0732a; }
  .sev-Medium    { background:#fffbe0; color:#9a7d0a; }
  .sev-Low       { background:#e8f8e8; color:#1e8449; }
  .sev-Info      { background:#e8f0ff; color:#1a5276; }
  .badge-sm { display:inline-block; padding:3px 10px; border-radius:4px; font-size:0.8rem; font-weight:600; }
  .status-open        { background:#fde8e8; color:#a93226; }
  .status-in_progress { background:#fef9e7; color:#9a7d0a; }
  .status-resolved    { background:#e8f8e8; color:#1e8449; }
  .status-wont_fix    { background:#ececec; color:#555; }
  .src-sca    { background:#e8f0ff; color:#1a5276; }
  .src-dast   { background:#fde8f0; color:#7b1f42; }
  .src-pentest{ background:#f0e8ff; color:#5b2c8c; }
  .src-manual { background:#f0f0f0; color:#444; }
  .timeline-item { display:flex; gap:0.75rem; padding:0.6rem 0; border-bottom:1px solid #f0f0f0; font-size:0.88rem; }
  .tl-dot { width:10px; height:10px; border-radius:50%; background:#002855; margin-top:5px; flex-shrink:0; }
  .comment-item { padding:0.75rem; border:1px solid #dee2e6; border-radius:6px; margin-bottom:0.75rem; }
</style>

<div style="display:grid; grid-template-columns:2fr 1fr; gap:1.5rem; align-items:start;">

  <!-- Left: Details -->
  <div>
    <div class="card" style="margin-bottom:1rem;">
      <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;">
        <span class="badge-sm sev-<%= vuln.severity %>"><%= vuln.severity %></span>
        <span class="badge-sm status-<%= vuln.status %>"><%= vuln.status.replace('_',' ') %></span>
        <span class="badge-sm src-<%= vuln.source %>"><%= vuln.source.toUpperCase() %></span>
        <% if (vuln.cwe) { %><span class="badge-sm" style="background:#f0f0f0;color:#444;"><%= vuln.cwe %></span><% } %>
        <% if (vuln.cvss_score) { %><span class="badge-sm" style="background:#f0f0f0;color:#444;">CVSS <%= vuln.cvss_score %></span><% } %>
        Priority <%= vuln.priority %>
      </div>

      <% if (vuln.owasp_category) { %><p style="font-size:0.85rem; color:#666; margin-bottom:0.75rem;"><%= vuln.owasp_category %></p><% } %>
      <% if (vuln.affected_component) { %><p style="margin-bottom:0.75rem;"><strong>Affected:</strong> <code><%= vuln.affected_component %></code></p><% } %>

      <h3 style="margin-bottom:0.5rem;">Description</h3>
      <p style="line-height:1.7; margin-bottom:1rem;"><%= vuln.description %></p>

      <% if (vuln.remediation_plan) { %>
      <h3 style="margin-bottom:0.5rem;">Remediation Plan</h3>
      <p style="line-height:1.7;"><%= vuln.remediation_plan %></p>
      <% } %>
    </div>

    <!-- Status history -->
    <div class="card" style="margin-bottom:1rem;">
      <h3 style="margin-bottom:0.75rem;">Status History</h3>
      <% if (!history.length) { %><p style="color:#999; font-size:0.9rem;">No transitions yet.</p><% } %>
      <% history.forEach(h => { %>
      <div class="timeline-item">
        <div class="tl-dot"></div>
        <div>
          <strong><%= h.old_status.replace('_',' ') %> → <%= h.new_status.replace('_',' ') %></strong>
          by user #<%= h.changed_by %>
          <span style="color:#999; font-size:0.8rem;"> · <%= new Date(h.changed_at).toLocaleString() %></span>
          <% if (h.note) { %><div style="color:#555; margin-top:2px;"><%= h.note %></div><% } %>
        </div>
      </div>
      <% }) %>
    </div>

    <!-- Comments -->
    <div class="card">
      <h3 style="margin-bottom:0.75rem;">Comments (<%= comments.length %>)</h3>
      <% comments.forEach(c => { %>
      <div class="comment-item">
        <div style="font-weight:600; margin-bottom:4px;"><%= c.username %> <span style="font-weight:400; color:#999; font-size:0.8rem;"><%= new Date(c.created_at).toLocaleString() %></span></div>
        <p style="font-size:0.9rem; color:#333; line-height:1.6;"><%= c.body %></p>
      </div>
      <% }) %>

      <form method="POST" action="/vm/vulns/<%= vuln.id %>/comments" style="margin-top:0.75rem;">
        <textarea name="body" rows="3" placeholder="Add a comment…" required
          style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem; margin-bottom:0.5rem;"></textarea>
        <button type="submit" style="background:#002855; color:#fff; border:none; border-radius:4px; padding:8px 16px; cursor:pointer;">Post Comment</button>
      </form>
    </div>
  </div>

  <!-- Right: Actions -->
  <div>
    <% if (user.role !== 'student') { %>
    <!-- Status transition -->
    <div class="card" style="margin-bottom:1rem;">
      <h3 style="margin-bottom:1rem;">Change Status</h3>
      <% if (!validNext.length) { %>
        <p style="color:#999; font-size:0.9rem;">No transitions available from <strong><%= vuln.status %></strong>.</p>
      <% } else { %>
        <div id="statusMsg" style="margin-bottom:0.75rem; font-size:0.9rem;"></div>
        <div id="resolveFields" style="display:none; margin-bottom:0.75rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.4rem;">Resolution Notes <span style="color:red;">*</span></label>
          <textarea id="resolutionNotes" rows="3" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;"></textarea>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.4rem;">Transition Note</label>
          <textarea id="statusNote" rows="2" style="width:100%; padding:8px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;" placeholder="Optional note…"></textarea>
        </div>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
          <% validNext.forEach(s => { %>
            <% if (s === 'wont_fix' && user.role !== 'admin') return; %>
            <button onclick="changeStatus('<%= s %>')"
              style="background:<%= s==='resolved'?'#1e8449':s==='wont_fix'?'#555':'#002855' %>; color:#fff; border:none; border-radius:4px; padding:8px 14px; cursor:pointer; font-size:0.9rem;">
              → <%= s.replace('_',' ') %>
            </button>
          <% }) %>
        </div>
      <% } %>
    </div>

    <!-- Edit fields -->
    <div class="card" style="margin-bottom:1rem;">
      <h3 style="margin-bottom:0.75rem;">Edit</h3>
      <form method="POST" action="/vm/vulns/<%= vuln.id %>/update">
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.3rem; font-size:0.9rem;">Severity</label>
          <select name="severity" style="width:100%; padding:6px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
            <% SEVERITIES.forEach(s => { %><option value="<%= s %>" <%= vuln.severity===s?'selected':'' %>><%= s %></option><% }) %>
          </select>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.3rem; font-size:0.9rem;">Priority (1=highest)</label>
          <select name="priority" style="width:100%; padding:6px; border:1px solid #ced4da; border-radius:4px; font-size:0.9rem;">
            <% [1,2,3,4].forEach(p => { %><option value="<%= p %>" <%= vuln.priority===p?'selected':'' %>><%= p %></option><% }) %>
          </select>
        </div>
        <div style="margin-bottom:0.75rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.3rem; font-size:0.9rem;">Remediation Plan</label>
          <textarea name="remediation_plan" rows="3" style="width:100%; padding:6px; border:1px solid #ced4da; border-radius:4px; font-size:0.85rem;"><%= vuln.remediation_plan || '' %></textarea>
        </div>
        <button type="submit" style="background:#6c757d; color:#fff; border:none; border-radius:4px; padding:6px 14px; cursor:pointer; font-size:0.9rem;">Save</button>
      </form>
    </div>

    <% if (user.role === 'admin') { %>
    <div class="card">
      <h3 style="margin-bottom:0.75rem; color:#a93226;">Danger Zone</h3>
      <button onclick="deleteVuln()" style="background:#c0392b; color:#fff; border:none; border-radius:4px; padding:8px 14px; cursor:pointer;">Delete Vulnerability</button>
    </div>
    <% } %>
    <% } %>

    <div class="card">
      <h3 style="margin-bottom:0.5rem;">Metadata</h3>
      <dl style="font-size:0.88rem; line-height:2;">
        <dt style="font-weight:600;">Source</dt><dd><%= vuln.source.toUpperCase() %> #<%= vuln.source_id || '—' %></dd>
        <dt style="font-weight:600;">Created</dt><dd><%= new Date(vuln.created_at).toLocaleString() %></dd>
        <dt style="font-weight:600;">Updated</dt><dd><%= new Date(vuln.updated_at).toLocaleString() %></dd>
        <% if (vuln.cvss_vector) { %><dt style="font-weight:600;">CVSS Vector</dt><dd style="font-size:0.8rem; word-break:break-all;"><%= vuln.cvss_vector %></dd><% } %>
      </dl>
    </div>
  </div>
</div>

<script>
function changeStatus(newStatus) {
  const note = document.getElementById('statusNote').value;
  const resolutionNotes = document.getElementById('resolutionNotes').value;
  const msg = document.getElementById('statusMsg');

  if (newStatus === 'resolved') {
    document.getElementById('resolveFields').style.display = 'block';
    if (!resolutionNotes.trim()) {
      msg.style.color = '#721c24';
      msg.textContent = 'Please enter resolution notes before marking as resolved.';
      return;
    }
  }

  fetch('/vm/vulns/<%= vuln.id %>/status', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
    body: `newStatus=${encodeURIComponent(newStatus)}&note=${encodeURIComponent(note)}&resolution_notes=${encodeURIComponent(resolutionNotes)}`
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      msg.style.color = '#155724';
      msg.textContent = 'Status updated! Reloading…';
      setTimeout(() => location.reload(), 600);
    } else {
      msg.style.color = '#721c24';
      msg.textContent = data.error || 'Error updating status.';
    }
  })
  .catch(() => { msg.style.color='#721c24'; msg.textContent='Network error.'; });
}

// Show resolution notes field when "resolved" button is visible
document.addEventListener('DOMContentLoaded', () => {
  const resBtn = document.querySelector('button[onclick*="resolved"]');
  if (resBtn) {
    resBtn.addEventListener('mouseenter', () => {
      document.getElementById('resolveFields').style.display = 'block';
    });
  }
});

async function deleteVuln() {
  if (!confirm('Permanently delete this vulnerability? This cannot be undone.')) return;
  if (!confirm('Are you sure? All history and comments will also be removed.')) return;
  try {
    const res = await fetch('/vm/vulns/<%= vuln.id %>/delete', {method:'POST', headers:{'Accept':'application/json'}});
    const data = await res.json();
    if (data.success) { window.location.href = '/vm'; }
    else alert(data.error);
  } catch(e) { alert('Network error'); }
}
</script>

<%- include('../partials/footer') %>
